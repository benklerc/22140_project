---
title: "Dexseqanalysis"
format: html
---

# Dexseq vs Deseq analysis

```{r}
#converting to dataframe
dxdResult_08_df <- as.data.frame(dxdResult_08)
dxdResult_77_df <- as.data.frame(dxdResult_77)

#ordering them:
dxdResult_08_df <- dxdResult_08_df[order(dxdResult_08_df$padj),]
dxdResult_77_df <- dxdResult_77_df[order(dxdResult_77_df$padj),]

```

```{r}
#making the deseq into dataframes
deseq_08_df <- as.data.frame(res_gender_age_08)
deseq_77_df <- as.data.frame(res_gender_age_77)
deseq_08_df$gene_id <- rownames(deseq_08_df)
deseq_77_df$gene_id <- rownames(deseq_77_df)
```

## comparing to differential expression:

#### function that turns Dexseq into gene counts

```{r}
dexseq_to_genelevel <- function(x) {
  x %>%
    as.data.frame() %>%
    as_tibble() %>%
    # Remove rows with NULL or NA 'stat'
    filter(!is.na(stat)) %>%
    # Select & rename columns
    dplyr::select(
      gene_id   = groupID,
      isoform_id = featureID,
      stat,
      log2FC = log2fold_parkinson.s_healthy,
      pvalue,
      padj
    ) %>%
    # Group isoforms by gene
    group_by(gene_id) %>%
    # Keep isoform with smallest p-value
    slice_min(order_by = pvalue, n = 1, with_ties = FALSE) %>%
    ungroup() %>%
    # Recalculate gene-level FDR
    mutate(
      padj = p.adjust(pvalue, method = "fdr")
    )
}
```

### 08 analysis

```{r}
# dexseq per-gene q-values
alpha <- 0.05
dex_gene_08 <- dexseq_to_genelevel(dxdResult_08)

dex_gene_08 <- dex_gene_08 %>%
  mutate(gene_id, dex_padj_08 = padj,
         dex_sig_08 = !is.na(padj) & padj < alpha)
#Deseq2 gene_level q-values
deseq_gene_08 <- deseq_08_df %>%
  mutate(gene_id, deseq_padj = padj,
         deseq_sig_08 = !is.na(padj) & padj < alpha)

#gene universe = genes present in both results

univ_08 <- intersect(dex_gene_08$gene_id, deseq_gene_08$gene_id)

both_08 <- dex_gene_08 %>%
  filter(gene_id %in% univ_08) %>%
  mutate(gene_id, dex_sig_08) %>%
  inner_join(deseq_gene_08 %>%
               filter(gene_id %in% univ_08) %>%
               mutate(gene_id, deseq_sig_08), by = "gene_id")
# Contigency table(dexseq vs deseq significance)
contig_tab_08 <- table(DEXseq_08 = both_08$dex_sig_08, DESeq2_08 = both_08$deseq_sig_08)
contig_tab_08

```

### fisher test for the 08 testset

```{r}
#fisherstest
ft_08 <- fisher.test(contig_tab_08, alternative = "greater")
ft_08
```

**This means that it is not significantly enriched. In other words, they describe different layers of what we are researching as there is not a big overlap.**

## comparing to differential gene expression at gene-level

```{r}
BP_df = msigdbr(species = "human", category = "C5", subcategory = "BP")
BP_list = split(BP_df$ensembl_gene, BP_df$gs_name)
```

```{r}
# Create the ranked list of gene-level statistics
deseq_names_08 <- sub("\\.\\d+$", "", deseq_gene_08$gene_id)
deseq_vals_08 <- deseq_gene_08$stat
stats_deseq_08 <- setNames(deseq_vals_08, deseq_names_08)
stats_deseq_08 <- stats_deseq_08[!is.na(stats_deseq_08)]
stats_deseq_08 <- sort(stats_deseq_08, decreasing = TRUE)
```

```{r}
# Create the ranked list of isoform-level statistics
dex_names_08 <- sub("\\.\\d+$", "", dex_gene_08$gene_id)
dex_vals_08 <- dex_gene_08$stat
stats_dex_08 <- setNames(dex_vals_08, dex_names_08)
stats_dex_08 <- stats_dex_08[!is.na(stats_dex_08)]
stats_dex_08 <- sort(stats_dex_08, decreasing = TRUE)
```

```{r}
fg_deseq_08 <- fgseaMultilevel(pathways = BP_list, stats = stats_deseq_08,
minSize = 15, maxSize = 500, scoreType = "std")
```

```{r}
fg_dex_08 <- fgseaMultilevel(pathways = BP_list, stats = stats_dex_08,
minSize = 15, maxSize = 500, scoreType = "std")

```

```{r}
sig_deseq_08 <- fg_deseq_08 %>% filter(padj < alpha) %>% arrange(padj)
sig_dex_08 <- fg_dex_08 %>% filter(padj < alpha) %>% arrange(padj)
# counts

n_sig_de_08 <- nrow(sig_deseq_08)
n_sig_dx_08 <- nrow(sig_dex_08)
# shared pathways (by name)
shared_08 <- intersect(sig_deseq_08$pathway, sig_dex_08$pathway)
n_shared_08 <- length(shared_08)
c(n_shared_08, n_sig_de_08, n_sig_dx_08)
```

**We get 0 shared genes, because there is for some reason 0 significant genes in the dexseq, and 1828 in the deseq**

```{r}

# Keep just what we need and rename
de_df_08 <- fg_deseq_08 %>%
transmute(pathway, NES_de_08 = NES, padj_de_08 = padj)
dx_df_08 <- fg_dex_08 %>%
transmute(pathway, NES_dx_08 = NES, padj_dx_08 = padj)
# Merge on pathway (shared sets only)
cmp_08 <- inner_join(de_df_08, dx_df_08, by = "pathway") %>%
mutate(sig_cat_08 = case_when(
padj_de_08 < alpha & padj_dx_08 < alpha ~ "Both",
padj_de_08 < alpha & padj_dx_08 >= alpha ~ "DESeq2 only",
padj_de_08 >= alpha & padj_dx_08 < alpha ~ "DEXSeq only",
TRUE ~ "None"
)) %>%
mutate(sig_cat_08 = factor(sig_cat_08, levels = c("Both","DESeq2 only","DEXSeqonly","None")))
```

```{r}
# Scatter + smooth
nes_comparison_plot_08 <- ggplot(cmp_08, aes(x = NES_de_08, y = NES_dx_08, color = sig_cat_08)) +
geom_point(alpha = 0.8) +
geom_smooth(method = "lm", se = FALSE) +
labs(
x = "NES (DESeq2 fgsea)",
y = "NES (DEXSeq fgsea)",
color = "Significance",
title = "NES comparison: DESeq2 vs DEXSeq (fgseaMultilevel)"
) +
theme_minimal()
# save plot
ggsave("../fig/nes_comparison_deseq_dex_08.png", plot = nes_comparison_plot_08)
```

**Spearman correlation**

```{r}
spearman_cor_08 <- cor(cmp_08$NES_de_08, cmp_08$NES_dx_08, method = "spearman", use ="complete.obs")
spearman_cor_08
```

# 77 ANALYSIS (Parallel to 08)

```{r}
alpha <- 0.05

# ---------------------------------------------------------------------------
# 1) Convert DEXSeq to gene-level statistics
# ---------------------------------------------------------------------------

dex_gene_77 <- dexseq_to_genelevel(dxdResult_77)

dex_gene_77 <- dex_gene_77 %>%
  mutate(
    gene_id,
    dex_padj_77 = padj,
    dex_sig_77 = !is.na(padj) & padj < alpha
  )

# ---------------------------------------------------------------------------
# 2) Prepare DESeq2 gene-level dataframe
# ---------------------------------------------------------------------------

deseq_gene_77 <- deseq_77_df %>%
  mutate(
    gene_id,
    deseq_padj_77 = padj,
    deseq_sig_77 = !is.na(padj) & padj < alpha
  )

# ---------------------------------------------------------------------------
# 3) Universe of overlapping genes
# ---------------------------------------------------------------------------

univ_77 <- intersect(dex_gene_77$gene_id, deseq_gene_77$gene_id)

# ---------------------------------------------------------------------------
# 4) Combine per-gene significance for both methods
# ---------------------------------------------------------------------------

both_77 <- dex_gene_77 %>%
  filter(gene_id %in% univ_77) %>%
  mutate(gene_id, dex_sig_77) %>%
  inner_join(
    deseq_gene_77 %>%
      filter(gene_id %in% univ_77) %>%
      mutate(gene_id, deseq_sig_77),
    by = "gene_id"
  )

# ---------------------------------------------------------------------------
# ---------------------------------------------------------------------------


```

# 5) Contingency table (DEXSeq vs DESeq2 significance)

```{r}
contig_tab_77 <- table(
  DEXSeq_77 = both_77$dex_sig_77,
  DESeq2_77 = both_77$deseq_sig_77
)
contig_tab_77


```

6)  Fisher test for enrichment of overlapping significant genes

```{r}
# ---------------------------------------------------------------------------
# ---------------------------------------------------------------------------

ft_77 <- fisher.test(contig_tab_77, alternative = "greater")
ft_77

#
```

7)  MSigDB pathways (already loaded)
8)  Ranked DESeq2 statistics

```{r}
deseq_names_77 <- sub("\\.\\d+$", "", deseq_gene_77$gene_id)
deseq_vals_77 <- deseq_gene_77$stat
stats_deseq_77 <- setNames(deseq_vals_77, deseq_names_77)
stats_deseq_77 <- stats_deseq_77[!is.na(stats_deseq_77)]
stats_deseq_77 <- sort(stats_deseq_77, decreasing = TRUE)
```

```{r}

```

9)  Ranked DEXSeq (per-gene) statistics

```{r}

dex_names_77 <- sub("\\.\\d+$", "", dex_gene_77$gene_id)
dex_vals_77 <- dex_gene_77$stat
stats_dex_77 <- setNames(dex_vals_77, dex_names_77)
stats_dex_77 <- stats_dex_77[!is.na(stats_dex_77)]
stats_dex_77 <- sort(stats_dex_77, decreasing = TRUE)
```

10) fgseaMultilevel for DESeq2 and DEXSeq

```{r}
fg_deseq_77 <- fgseaMultilevel(
  pathways = BP_list,
  stats = stats_deseq_77,
  minSize = 15,
  maxSize = 500,
  scoreType = "std"
)

fg_dex_77 <- fgseaMultilevel(
  pathways = BP_list,
  stats = stats_dex_77,
  minSize = 15,
  maxSize = 500,
  scoreType = "std"
)
```

11) Significant pathways

```{r}
sig_deseq_77 <- fg_deseq_77 %>% filter(padj < alpha) %>% arrange(padj)
sig_dex_77   <- fg_dex_77   %>% filter(padj < alpha) %>% arrange(padj)

n_sig_de_77  <- nrow(sig_deseq_77)
n_sig_dx_77  <- nrow(sig_dex_77)

shared_77 <- intersect(sig_deseq_77$pathway, sig_dex_77$pathway)
n_shared_77 <- length(shared_77)

c(n_shared_77, n_sig_de_77, n_sig_dx_77)

```

12) Merge fgsea results for NES comparison

```{r}


de_df_77 <- fg_deseq_77 %>%
  transmute(pathway, NES_de_77 = NES, padj_de_77 = padj)

dx_df_77 <- fg_dex_77 %>%
  transmute(pathway, NES_dx_77 = NES, padj_dx_77 = padj)

cmp_77 <- inner_join(de_df_77, dx_df_77, by = "pathway") %>%
  mutate(
    sig_cat_77 = case_when(
      padj_de_77 < alpha & padj_dx_77 < alpha ~ "Both",
      padj_de_77 < alpha & padj_dx_77 >= alpha ~ "DESeq2 only",
      padj_de_77 >= alpha & padj_dx_77 < alpha ~ "DEXSeq only",
      TRUE ~ "None"
    )
  ) %>%
  mutate(
    sig_cat_77 = factor(sig_cat_77, 
                        levels = c("Both", "DESeq2 only", "DEXSeq only", "None"))
  )
```

# 13) NES scatterplot comparison

```{r}
# ---------------------------------------------------------------------------

nes_comparison_plot_77 <- ggplot(cmp_77, aes(x = NES_de_77, y = NES_dx_77, color = sig_cat_77)) +
  geom_point(alpha = 0.8) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    x = "NES (DESeq2 fgsea)",
    y = "NES (DEXSeq fgsea)",
    color = "Significance",
    title = "NES comparison: DESeq2 vs DEXSeq (fgseaMultilevel) â€” Dataset 77"
  ) +
  theme_minimal()
ggsave("../fig/nes_comparison_deseq_dex_77.png", plot = nes_comparison_plot_77)
```

14) Spearman correlation

```{r}
# ---------------------------------------------------------------------------

spearman_cor_77 <- cor(
  cmp_77$NES_de_77,
  cmp_77$NES_dx_77,
  method = "spearman",
  use = "complete.obs"
)
spearman_cor_77
```
