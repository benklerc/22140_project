---
title: "exploratory_analysis"
format: html
---

# Setting up data

```{r}
library(DEXSeq)
library(fgsea)
library(msigdbr)
library(stringr)
library(knitr)
library(dplyr)
library(tidyr)

load(file='/home/projects/22140/exam_data/exam_functions.Rdata')

isoform_count_08 <-loadIsoformCountMatrix('GSE106608')
isoform_count_77 <-loadIsoformCountMatrix('GSE128177')

gene_count_08 <- extractGeneCountMatrixFromIsoCounts(isoform_count_08)
gene_count_77 <- extractGeneCountMatrixFromIsoCounts(isoform_count_77)

isoform_count_08 <- as.data.frame(isoform_count_08)

isoform_count_77 <- as.data.frame(isoform_count_77)

isoInfo <- read_rds(
paste0(
'/home/projects/22140/exam_data/',
'Homo_sapiens.GRCh38.107.chr_patch_hapl_scaff_tx_info.Rds'
)
)
```

### Meta data

```{r}
file_path_08 <- "../metadata_temporary/Template_group6_GSE106608.csv"

metadata_df_08 <- read.csv(
  file_path_08,
  skip = 6,
  stringsAsFactors = FALSE
)
colnames(metadata_df_08)[5] <- "groups"

head(metadata_df_08)

```

```{r}
file_path_77 <- "../metadata_temporary/Template_group6_GSE128177.csv"

metadata_df_77 <- read.table(
  file_path_77,
  sep = ";",
  header = TRUE,
  skip = 6,
  stringsAsFactors = FALSE,
  quote = "\""   # Handle quoted fields
)

colnames(metadata_df_77)[5] <- "groups"

# Remove quotes from groups column
metadata_df_77$groups <- gsub("\"", "", metadata_df_77$groups)

metadata_df_77
```

### Splitting characteristics into gender and age

#### 08 datafile

```{r}
metadata_df_08 <- metadata_df_08 |>
  mutate(gender = str_extract(characteristics, "(?<=Sex: )\\w$")
  )

metadata_df_08 <- metadata_df_08 |>
  mutate(
    age = as.integer(str_extract(characteristics, "(?<=age: )\\d+"))
  )

head(metadata_df_08)
```

#### 77 datafile

```{r}
metadata_df_77 <- metadata_df_77 |>
  mutate(
    gender = str_extract(characteristics, "(?<=gender: )[^,]+")
  )

metadata_df_77 <- metadata_df_77 |>
  mutate(
    age = as.integer(str_extract(characteristics, "(?<=age: )\\d+"))
  )

metadata_df_77 <- metadata_df_77 |>
  mutate(
    patient_type = str_extract(characteristics, "(?<=group: )[^,]+$")
  )

print(metadata_df_77)
```

### Subset 77 data

```{r}
metadata_df_77_sub <- metadata_df_77 |>
  filter(patient_type != "Young_adult")

correct_samples <- metadata_df_77_sub$sample_id

gene_count_77_sub <- gene_count_77[, colnames(gene_count_77) %in% correct_samples]

isoform_count_77_sub <- isoform_count_77[, colnames(isoform_count_77) %in% correct_samples]

```

```{r}
dim(isoform_count_77)
dim(isoform_count_77_sub)
```

# Load Result files

```{r}

```

```{r}
res_gender_age_08 <- readRDS('../data/deseq2_results_08_age')
res_gender_age_77 <- readRDS('../data/deseq2_results_77_age_sub.rds') 
dxdResult_08 <- readRDS('../data/dexseq_results_08_age.rds') 
dxdResult_77 <- readRDS('../data/dexseq_results_77_age_sub.rds')
```

```{r}
df_deseq_08_age <- as.data.frame(res_gender_age_08)
df_deseq_77_age <- as.data.frame(res_gender_age_77)
df_dexseq_08 <- as.data.frame(dxdResult_08)
df_dexseq_77 <- as.data.frame(dxdResult_77)
```

```{r}
dxdResult_77_sub <- readRDS('../data/dexseq_results_77_sub.rds')
df_dexseq_77_sub <- as.data.frame(dxdResult_77_sub)
```

# Distributions

```{r}
# ==============================================================================
#                  Dataset 08: GSE106608 (Brain sample) Metadata
# ==============================================================================

# Gender Distribution by Group (Bar Plot)
plot_08_gender_by_group <- metadata_df_08 |>
  ggplot(aes(x = gender, fill = groups)) +
  geom_bar(position = "dodge") +
  labs(
    title = "Gender Distribution by Group (Brain sample)",
    x = "Gender",
    y = "Count",
    fill = "Group"
  ) +
  theme_minimal() +
  scale_fill_manual(
    values = c(
      "healthy" = "skyblue",       # Your desired teal/mint
      "parkinson's" = "#0066CC"    # A close hex code for the salmon/orange
    )
  )


print(plot_08_gender_by_group)


# Age Distribution by Group (Density Plot)
plot_08_age_by_group <- metadata_df_08 |>
  ggplot(aes(x = age, fill = groups)) +
  geom_density(alpha = 0.5) + # alpha=0.5 allows overlapping curves to be visible
  labs(
    title = "Age Distribution by Group (Brain sample)",
    x = "Age",
    y = "Density",
    fill = "Group"
  ) +
  theme_minimal() +
    scale_fill_manual(
    values = c(
      "healthy" = "skyblue",       # Your desired teal/mint
      "parkinson's" = "#0066CC"    # A close hex code for the salmon/orange
    )
  ) +
  # === FIX: Manually set x-axis limits for padding ===
  # Assuming age ranges from ~20 to ~90, we add padding (e.g., 5 units)
  scale_x_continuous(limits = c(min(metadata_df_08$age, na.rm = TRUE) - 10, 
                                max(metadata_df_08$age, na.rm = TRUE) + 10))

print(plot_08_age_by_group)

# ==============================================================================
#        Dataset 77: GSE128177 (Muscle sample) Subset Metadata 
# ==============================================================================

# Gender Distribution by Group (Bar Plot)
plot_77_gender_by_group <- metadata_df_77_sub |>
  ggplot(aes(x = gender, fill = groups)) +
  geom_bar(position = "dodge") +
  labs(
    title = "Gender Distribution by Group (Muscle sample)",
    x = "Gender",
    y = "Count",
    fill = "Group"
  ) +
  theme_minimal() +
    scale_fill_manual(
    values = c(
      "healthy" = "skyblue",       # Your desired teal/mint
      "parkinson's" = "#0066CC"    # A close hex code for the salmon/orange
    )
  )

print(plot_77_gender_by_group)


# Age Distribution by Group (Density Plot)
plot_77_age_by_group <- metadata_df_77_sub |>
  ggplot(aes(x = age, fill = groups)) +
  geom_density(alpha = 0.5) + # alpha=0.5 allows overlapping curves to be visible
  labs(
    title = "Age Distribution by Group (Muscle sample)",
    x = "Age",
    y = "Density",
    fill = "Group"
  ) +
  theme_minimal() +
    scale_fill_manual(
    values = c(
      "healthy" = "skyblue",       # Your desired teal/mint
      "parkinson's" = "#0066CC"    # A close hex code for the salmon/orange
    )
  ) +
  # === FIX: Manually set x-axis limits for padding ===
  scale_x_continuous(limits = c(min(metadata_df_77_sub$age, na.rm = TRUE) - 10, 
                                max(metadata_df_77_sub$age, na.rm = TRUE) + 10))

print(plot_77_age_by_group)

# Save 08 plots
ggsave("../fig/08_gender_by_group.png", plot = plot_08_gender_by_group)
ggsave("../fig/08_age_by_group.png", plot = plot_08_age_by_group)

# Save 77 plots
ggsave("../fig/77_gender_by_group.png", plot = plot_77_gender_by_group)
ggsave("../fig/77_age_by_group.png", plot = plot_77_age_by_group)
```

```{r}
teal_color <- RColorBrewer::brewer.pal(3, "Set2")[1]
print(teal_color)
```

```{r}
summarize_data <- function(counts_df, metadata_df, dataset_name) {
  
  num_genes <- nrow(counts_df)
  num_samples <- ncol(counts_df)
  
  # Extract unique groups/conditions
  conditions <- unique(metadata_df$groups)
  
  # Use stringr to combine conditions into a single string
  conditions_str <- str_c(conditions, collapse = " / ")
  
# Calculate specific sample counts
  num_parkinsons <- sum(metadata_df$groups == "parkinson's", na.rm = TRUE)
  num_healthy <- sum(metadata_df$groups == "healthy", na.rm = TRUE)
  
  # Create a data frame for the summary
  data.frame(
    Dataset = dataset_name,
    `Number of Genes` = num_genes,
    `Total Samples` = num_samples,
    `Parkinson's Samples` = num_parkinsons,
    `Healthy Samples` = num_healthy,
    Conditions = conditions_str,
    check.names = FALSE
  )
}

# Generate summaries
summary_08 <- summarize_data(
  counts_df = gene_count_08, 
  metadata_df = metadata_df_08, 
  dataset_name = "GSE106608 (Brain sample)"
)

summary_77 <- summarize_data(
  counts_df = gene_count_77, 
  metadata_df = metadata_df_77, 
  dataset_name = "GSE128177 (Muscle sample)"
)

# --- Combine and print the final table using Base R print ---
summary_table <- rbind(summary_08, summary_77)
print(summary_table)

```

# Questions

-   Combine all 4 dataset, combine them all at once or pariwise and then 08 and 77 together

    -   first do gene count and isoform count for one dataset(fishers)

    -   and then integrate both datasets(edigtons)

    -   order could also be turned around(slightly different result, but not extreme)

-   significance of contrast in DeSeq2 results?

    -   take the difference between the contrast

-   negative ES means downregulation\[Gemini: Yes, in average the genes are downregulated\]? Why is the directional and non-directional FGSEA so different?

    -   look at biology, choose focus

    -   non-directional, if pathways have genes that are downerglated and upregulated these are scored significantly now

-   What is leading Edge in the FGSEA analysis?

    -   gene list from max ES value to start

    -   list of genes which contributes most

-   Why do we have so few significant isoform and genes in the 77 datatset

    -   ensure it is the same for both datasets

    -   then interpret

-   Why do we use fishers test to integrate two transcriptional dataset? Why not edingtons? Is DeSeq and DEXSeq not from the same level

    -   use different ones for the two levels of integration

-   Why using unadjusted pvalue for integration?

    -   use unadjusted

-   Why do we suddenly have more significant genes in DEXSeq for 77 after the p-value integration

    -   maybe adjustment was done on fewer genes now

-   How long is the presentation supposed to be?

# TODOs

-   Find out the meaning of contrast in the Result pulling of DeSeq2(Interpretation of Age as cofounder)

    -   try out only age+condition

    -   look at age distribution

    -   do analysis inlcuding age

-   Numberof genes in isoforms == number of genes in genecount(Cora)

-   Basic research on Parkinson(Sander)

-   GSEA on DEXSeq(Malte)

-   DEXSeq with condition+gender+age(Malte)

-   DeSeq2 with condition, gender, age and all following analysis(Cecilie)

-   Comparisons of DeSeq2 and DEXSeq(week6, Sander)

-   77: remove young healthy adults, rerun DEXSeq(if more significant also need to rerun all other analysis)(Cecilie)

-   Figure folder, save plots(PCA)(Amanda)

-   Start Presentation(Cecilie)

    -   introduction(Background-Sander, Data-Cora)

-   p-value integration in 2 steps(Cora)

    -   GSEA

-   Virtual Pulldown(Malte?/whoever has time, please write in group if you start with this)

    -   cluster

    -   assign biological function

```{r}
isoform_count_08 %>% group_by()

isoInfo
```
